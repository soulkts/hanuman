Authorize.net 카드 결제 연동
1. authorize란?
미국의 뱅크 오브 아메리카가 만든 일종의 PG사. 역직구 쇼핑몰을 운영하려면 해외 결제가 가능해야하는데, 대표적인 해외 결제사가 페이팔. 페이팔은 이미 사이트에 붙여 놓았지만 카드 결제를 부각 시키고 싶다는 얘기에 authorize를 추가 적용하기로 결정. 그래서 작업을 진행하게 되었는데 개인적인 정리 및 한글 자료가 턱없이 부족하기에 또 다른 이의 삽질을 조금이나마 덜어주고자 포스팅한다. 참고로 authorize.net 에서 계정을 모두 만들었다는 가정하에 진행한다. client key, merchant login id, transaction key 값 등이 필요한데 authorize.net의 관리자 페이지에서 발급 및 확인 가능하다.

2. 방식 안내
개인적으로는 authorize와 api 연동하는 부분보다는 결제 폼을 만드는 부분에서 고생을 좀 했다. HTML로 결제 폼을 만들고, CSS 입히고, 스크립트로 효과 주고, 유효성 검증하고.. 이런 일련의 과정들은 시간이 오래 걸려서 authorize에서 제공해 주는 기본 폼을 이용하고자 했다. (귀차니즘도 한 몫 했다)authorize에서 제공해 주는 결제 폼을 구현하는 방법은  4가지(3+1)인데 크게 Accept Hosted 방식과 Accept.js 방식으로 나뉜다.

https://developer.authorize.net/api/reference/features/accept_hosted.html

링크를 들어가보면 accept hosted 방식에 대해서 잘 나와있다.
이 방식의 특징은 authorize에서 리턴받은 토큰값을 설정값과 함께 authorize로 다시 보내면 결제 폼을 리턴해주는 형태다.
accept hosted 다이어그램

rediect 방식 : 말 그대로 authorize의 결제 페이지로 갔다가 돌아오는 방식. 
popup 방식 : 버튼 클릭과 같은 이벤트를 주면 popup 형태로 결제 폼이 나오는 방식.
embeded 방식 : 페이지 내에 iframe 형태로 결제 폼이 만들어 지는 방식.
위의 세 가지 방식 중 본인 마음에 드는 형태로 구현하면 된다. 하지만 난 이 방식을 사용하지 않았다. 리턴값을 받는 부분을 모르겠더라. 사이트에는 json 리턴값 예제가 나와있는데 정작 리턴을 어떻게 받는지에 대해서는 자세히 안 나와있더라. 혹시 아시는 분 있으시면 댓글 좀…

3. accept.js
자세한 사항은 https://developer.authorize.net/api/reference/features/acceptjs.html 에서 확인 가능하다. 이 방식을 사용한 이유는 기존 프로세스에 붙이기가 가장 쉬워서. 은탄환은 없다고 얘기하듯이 이 방식이 절대적으로 옳아서 선택한건 아니고 위의 세가지 방법을 하나씩 적용해 본 결과 이미 구현되어 있는 사이트의 결제 프로세스에 가장 잘 녹아서이다. 위의 방식은 앞서 설명했듯 리턴값 문제가 가장 큰 문제였고, 그 부분의 처리가 원활히 되지 않으면 우리 프로세스상 진행이 어려웠다. 그래서 리턴 형태가 명확히 기술 되어 있는 이 방식으로 결정.

accept.js 프로세스

여기도 굳이 나눈다면 두 가지로 나뉘는데, 하나는 심플하게 팝업 띄우는 것과 내가 꾸며서 팝업 띄우는 것.
작업 시간의 압박으로 인해 UI 디자인까지 손댈 자신이 없던 나는 심플한 방법으로. 다행히 컨펌이 떨어졌다.
PHP SDK 설치(결제 승인 절차에서 필요하다. 빼먹지 말자)
constants/SampleCodeConstants.php 수정 (authorize 관리자 페이지 들어가서 각 키 값을 받은 뒤 여기에 입력하면 된다. 파일 변경해서 진행해도 무방.)
결제 폼 페이지 코드
리턴값 결제 승인 보내는 코드
이메일 및 관리자 페이지에서 승인 완료 확인
4. 마무리 
해외 결제 서비스 중 하나인 authorize 세팅에 대해서 정리를 해봤다. 할때는 삽질의 연속이고 안되는게 왜 이리 많나 했지만.. 다 만들고 나면 간단해 보이는 마법. 이번에 적용할 때 카드 결제만 가능한 상태로 했는데 옵션 값을 변경하면 은행 결제도 가능하다. 해외 결제 서비스로 authorize를 직접 적용하려는 분들께 도움이 되었으면 좋겠다. 개인적으로는 페이팔을 쓰면 되지 않나? 라는 생각도 들지만 어쩌랴… 기획자나 윗분들 설득 하지 못하면 해야하는 것이 직장인것을…


추가사항!

의심거래(suspicious transaction)가 생각보다 많이 들어오더라.
AVS 처리(billing address가 다르다고 인식하는 문제
authorize는 zip code가 다르면 발생)에 문제가 있어 결제가 제대로 안되는 건들이 있었다. 관련 내용 찾아보고 조치를 했는데, 미국 카드만 된다는 얘기가 있어서(우리는 캐나다도 한다) 아예 account에서 AVS 필터를 꺼놓는것으로 해결했다.아무래도 보안상의 우려가 있어서 그 부분을 어필했지만… 
